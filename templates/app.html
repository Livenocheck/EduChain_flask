{% extends "base.html" %}

{% block content %}
<div id="loading" style="text-align: center; padding: 50px;">
  <div style="font-size: 48px;">‚è≥</div>
  <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram...</p>
</div>

<div id="app-content" style="display: none;">
  <style>
    .top-bar {
      background: white;
      padding: 12px 16px;
      margin: -16px -16px 20px -16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .balance { font-weight: bold; color: var(--success); font-size: 18px; }
  </style>
  
  <div class="container">
    <div class="top-bar">
      <div class="balance">ü™ô <span id="balance-value">0</span> —Ç–æ–∫–µ–Ω–æ–≤</div>
    </div>
    
    <div class="card" style="text-align: center;">
      <h2 style="margin: 0 0 16px 0;">üëã –ü—Ä–∏–≤–µ—Ç, <span id="student-name">...</span>!</h2>
      <p>–¢–≤–æ—è EduChain-—Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</p>
    </div>
    
    <button class="btn btn-primary" onclick="goToMarketplace()">üõí –ú–∞—Ä–∫–µ—Ç</button>
    <button class="btn btn-primary" onclick="goToUpload()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</button>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
    // –ù–µ –≤ Telegram ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∞–¥–º–∏–Ω–∫—É
    window.location.href = '/admin';
    return;
  }
  
  const initData = Telegram.WebApp.initData;
  if (!initData) {
    // Mini App –∑–∞–≥—Ä—É–∂–µ–Ω –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Üí –æ—à–∏–±–∫–∞
    document.getElementById('loading').innerHTML = '<p>–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram</p>';
    return;
  }

  let globalInitData = null;
  
  async function autoAuth() {
    const initData = Telegram.WebApp.initData;
    if (!initData) {
      window.location.href = '/';
      return;
    }
    
    const response = await fetch('/tg_app/auth', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({initData: initData})
    });
    
    const data = await response.json();
    if (data.valid) {
      globalInitData = data.initData;
      document.getElementById('student-name').textContent = data.student.name;
      document.getElementById('balance-value').textContent = data.balance;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app-content').style.display = 'block';
    } else {
      Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞: ' + data.error);
      setTimeout(() => window.location.href = '/', 2000);
    }
  }
  
  function goToMarketplace() {
    window.location.href = '/marketplace?initData=' + encodeURIComponent(globalInitData);
  }
  
  function goToUpload() {
    window.location.href = '/upload?initData=' + encodeURIComponent(globalInitData);
  }
  
  autoAuth();
</script>
{% endblock %}