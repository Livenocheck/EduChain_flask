{% extends "base.html" %}

{% block content %}
<div id="loading-screen" style="text-align: center; padding: 50px; display: none;">
  <div style="font-size: 48px;">‚è≥</div>
  <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram...</p>
</div>

<div id="app-content" style="display: none;">
  <style>
    .top-bar {
      background: white;
      padding: 12px 16px;
      margin: -16px -16px 20px -16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .balance { font-weight: bold; color: var(--success); font-size: 18px; }
  </style>

  <div class="container">
    <div class="top-bar">
      <div class="balance">ü™ô <span id="balance-value">0</span> —Ç–æ–∫–µ–Ω–æ–≤</div>
    </div>
    
    <div class="card" style="text-align: center;">
      <h2 style="margin: 0 0 16px 0;">üëã –ü—Ä–∏–≤–µ—Ç, <span id="student-name">...</span>!</h2>
      <p>–¢–≤–æ—è EduChain-—Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</p>
    </div>
    
    <button class="btn btn-primary" onclick="window.location.href='/marketplace'">üõí –ú–∞—Ä–∫–µ—Ç</button>
    <button class="btn btn-primary" onclick="window.location.href='/upload'">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</button>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ä–∞–∑—É
  document.getElementById('loading-screen').style.display = 'block';

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  async function autoAuth() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Telegram
    if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
      alert('–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram!');
      return;
    }
    
    const initData = Telegram.WebApp.initData;
    if (!initData) {
      alert('–ù–µ –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram');
      return;
    }

    try {
      const response = await fetch('/tg_app/auth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({initData: initData})
      });

      const data = await response.json();
      
      if (data.valid) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º initData –≤ localStorage –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        localStorage.setItem('initData', initData);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        document.getElementById('student-name').textContent = data.student.name;
        document.getElementById('balance-value').textContent = data.balance;
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º initData –≤ URL –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('initData', initData);
        window.history.replaceState({}, '', newUrl);
      } else {
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
  }

  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ Telegram
  Telegram.WebApp.BackButton.show();
  Telegram.WebApp.BackButton.onClick(function() {
    Telegram.WebApp.close();
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  autoAuth();
</script>
{% endblock %}