{% extends "base.html" %}

{% block content %}
<div class="container">
  <h2>üëõ –ú–æ–π TON-–∫–æ—à–µ–ª—ë–∫</h2>
  
  <!-- TON Connect (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±) -->
  <div id="ton-connect-button"></div>
  
  <!-- –ò–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ -->
  <div style="margin: 30px 0; padding: 20px; border: 1px dashed #ccc; border-radius: 8px;">
    <h3>–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é:</h3>
    <form method="POST" action="/update_wallet">
      <input type="text" name="ton_wallet" 
             value="{{ user.ton_wallet or '' }}" 
             placeholder="UQA... –∏–ª–∏ EQA..."
             style="width:100%; padding:10px; margin:10px 0;">
      <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
  </div>
  
  {% if user.ton_wallet %}
    <p>–¢–µ–∫—É—â–∏–π –∫–æ—à–µ–ª—ë–∫: <code>{{ user.ton_wallet }}</code></p>
  {% endif %}
</div>

<style>
  .container { max-width: 600px; margin: 0 auto; padding: 16px; }
  .btn { background: #0088cc; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; }
</style>

<!-- TON Connect SDK -->
<script src="https://unpkg.com/@tonconnect/ui@1.0.0/dist/tonconnect-ui.min.js"></script>
<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://{{ DOMAIN }}/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button'
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  tonConnectUI.onStatusChange(wallet => {
    if (wallet) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      fetch('/update_wallet_tonconnect', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({address: wallet.account.address})
      }).then(r => r.json()).then(data => {
        if (data.success) {
          alert('–ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω!');
          window.location.reload();
        }
      });
    }
  });
</script>
{% endblock %}