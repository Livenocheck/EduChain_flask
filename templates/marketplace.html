{% extends "base.html" %}

{% block content %}
<div id="loading" style="text-align: center; padding: 50px;">
  <div style="font-size: 48px;">üõí</div>
  <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä–∫–µ—Ç–∞...</p>
</div>

<div id="marketplace-content" style="display: none;">
  <style>
    .top-bar { background: white; padding: 12px 16px; margin: -16px -16px 20px -16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .balance { font-weight: bold; color: var(--success); font-size: 18px; }
    .reward { padding: 16px; border-radius: 16px; background: white; margin: 12px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .reward h3 { margin: 0 0 8px 0; }
    .reward p { margin: 4px 0; color: var(--text-light); }
    .out-of-stock { background: #f0f0f0 !important; color: #999 !important; }
  </style>

  <div class="container">
    <div class="top-bar">
      <div class="balance">ü™ô <span id="balance-value">0</span> —Ç–æ–∫–µ–Ω–æ–≤</div>
    </div>
    
    <h2 style="margin: 0 0 20px 0;">üõí –ú–∞—Ä–∫–µ—Ç</h2>
    
    <div id="rewards-container"></div>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const initData = urlParams.get('initData') || Telegram.WebApp.initData;
  
  if (!initData) {
    window.location.href = '/tg_app/';
  }

  async function loadMarketplace() {
    const response = await fetch('/marketplace/load', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({initData: initData})
    });
    const data = await response.json();
    
    if (data.valid) {
      document.getElementById('balance-value').textContent = data.balance;
      const container = document.getElementById('rewards-container');
      
      if (data.rewards.length === 0) {
        container.innerHTML = '<div class="card"><p style="text-align: center; color: var(--text-light);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥</p></div>';
      } else {
        data.rewards.forEach(reward => {
          const isAvailable = (reward.quantity === null) || (reward.quantity > 0);
          const qtyText = reward.quantity === null ? '‚àû' : reward.quantity;
          
          const div = document.createElement('div');
          div.className = 'reward';
          div.innerHTML = `
            <h3>${reward.name}</h3>
            <p>${reward.description || ''}</p>
            <p><strong>${reward.cost} ü™ô</strong></p>
            <p>–û—Å—Ç–∞—Ç–æ–∫: ${qtyText}</p>
            ${isAvailable ? 
              `<form method="POST" action="/marketplace/buy/${reward.id}" style="display:inline; width:100%;">
                <input type="hidden" name="initData" value="${initData}">
                <button type="submit" class="btn btn-success" style="width:100%;">–ö—É–ø–∏—Ç—å</button>
              </form>` :
              `<button class="btn out-of-stock" disabled>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</button>`
            }
          `;
          container.appendChild(div);
        });
      }
      document.getElementById('loading').style.display = 'none';
      document.getElementById('marketplace-content').style.display = 'block';
    } else {
      Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
      setTimeout(() => window.location.href = '/tg_app/', 1500);
    }
  }

  Telegram.WebApp.BackButton.show();
  Telegram.WebApp.BackButton.onClick(() => window.location.href = '/tg_app/');

  loadMarketplace();
</script>
{% endblock %}